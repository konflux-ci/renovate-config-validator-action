name: Validate MintMaker configuration with renovate-config-validator
author: Hozifa Wasfy
branding:
  icon: check
  color: green
description: |
  Validate MintMaker configuration with renovate-config-validator.
inputs:
  config_file:
    description: |
      Renovate configuration file
      By default, it validates every file that matches renovate configuration files. 

    required: false
runs:
  using: composite
  steps:
    - name: Validate Renovate configuration with renovate-config-validator
      run: |
        set -eu

        if [ -n "$CONFIG_FILE_PATH" ] && [ -f "$CONFIG_FILE_PATH" ]; then
          echo "Validating config_file: " "$CONFIG_FILE_PATH"
          
          config_path="$(pwd)/$CONFIG_FILE_PATH"
          echo $config_path
          
          # Run validator and capture both STDOUT and STDERR, preserve exit code
          set +e  # Don't exit on command failure
          podman run --rm \
          -v $config_path:/workspace/renovate.json:ro,Z \
          quay.io/konflux-ci/mintmaker-renovate-image:latest \
          renovate-config-validator /workspace/renovate.json 2>&1 | tee validation.log
          exit_code=$?
          set -e  # Re-enable exit on error

          echo "finished validating with exit code: $exit_code"
          
          # Exit with the same code as renovate-config-validator
          if [ $exit_code -ne 0 ]; then
            echo "Validation failed - see errors above"
            exit $exit_code
          else
            echo "Validation successful"
            exit 0
          fi

        fi
        
        echo "No config file was set"
        echo "Detecting renovate configuration files..."

        mkdir /opt/renovate-configs

        renovate_files=$(find . -name "*renovate*.json*")

        for f in $renovate_files; do
          if [ -f $f ]; then
            echo "Renovate file detected: $f"
            cp $f /opt/renovate-configs
          fi
        done 

        if [ -z $(ls /opt/renovate-configs) ]; then
          echo "No config files found"
          exit 1
        fi
        
        # Run validator and capture both STDOUT and STDERR, preserve exit code
        set +e  # Don't exit on command failure
        podman run --rm \
        -v /opt/renovate-configs:/workspace/renovate-configs \
        quay.io/konflux-ci/mintmaker-renovate-image:latest \
        renovate-config-validator /workspace/renovate-configs/renovate.json 2>&1 | tee validation.log
        exit_code=$?
        set -e  # Re-enable exit on error

        echo "finished validating with exit code: $exit_code"
        
        # Exit with the same code as renovate-config-validator
        if [ $exit_code -ne 0 ]; then
          echo "Validation failed - see errors above"
          exit $exit_code
        else
          echo "Validation successful"
          exit 0
        fi

      shell: bash
      env:
        CONFIG_FILE_PATH: ${{inputs.config_file}}
